// src/components/MapComponent.js
import React, { useEffect, useRef, useState, useCallback } from "react";
import { useDispatch } from "react-redux";
import { useNavigate } from "react-router-dom";
import { getList } from "../api/productsApi";
import { API_SERVER_HOST } from "../api/backendApi";
import useCustomCart from "../hooks/useCustomCart";
import useCustomLogin from "../hooks/useCustomLogin";
import { postChangeCartAsync, getCartItemsAsync } from "../slices/cartSlice";
import ResultModal from "./common/ResultModal";
import "./MapComponent.css";

const MapComponent = () => {
  const dispatch = useDispatch();
  const navigate = useNavigate();
  const mapRef = useRef(null);
  const markersRef = useRef([]);
  const infoWindowsRef = useRef([]);
  const myMarkerRef = useRef(null);

  const [places, setPlaces] = useState([]);
  const [myLocation, setMyLocation] = useState(null);
  const [searchKeyword, setSearchKeyword] = useState("");
  const [highlightIndex, setHighlightIndex] = useState(null);
  const [isLoadingLocation, setIsLoadingLocation] = useState(false);

  const [listType, setListType] = useState("place");
  const [products, setProducts] = useState([]);
  const [filteredProducts, setFilteredProducts] = useState([]);

  const { cartItems } = useCustomCart();
  const { loginState, isLogin } = useCustomLogin();

  const [modalVisible, setModalVisible] = useState(false);
  const [modalTitle, setModalTitle] = useState("");
  const [modalContent, setModalContent] = useState("");
  const [modalCallback, setModalCallback] = useState(null);

  const showModal = (title, content, callback) => {
    setModalTitle(title);
    setModalContent(content);
    setModalCallback(() => callback);
    setModalVisible(true);
  };

  useEffect(() => {
    const script = document.createElement("script");
    script.src =
      `https://dapi.kakao.com/v2/maps/sdk.js?appkey=${process.env.REACT_APP_KAKAO_MAP_KEY}` +
      "&autoload=false&libraries=services";
    script.async = true;
    script.onload = () => {
      window.kakao.maps.load(() => {
        // Ï¥àÍ∏∞ ÏßÄÎèÑ ÏÉùÏÑ± (Í∏∞Î≥∏ ÏúÑÏπò: ÏÑúÏö∏ Í∞ïÎÇ®)
        mapRef.current = new window.kakao.maps.Map(
          document.getElementById("map"),
          { center: new window.kakao.maps.LatLng(37.4981, 127.0276), level: 3 }
        );

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÌòÑÏû¨ ÏúÑÏπòÎ°ú Ïù¥Îèô Î∞è Ï£ºÎ≥Ä ÏãùÎãπ Í≤ÄÏÉâ
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const { latitude, longitude } = position.coords;
              const currentLocation = new window.kakao.maps.LatLng(
                latitude,
                longitude
              );
              const newLocation = { lat: latitude, lon: longitude };

              // ÏßÄÎèÑ Ï§ëÏã¨ÏùÑ ÌòÑÏû¨ ÏúÑÏπòÎ°ú Ïù¥Îèô
              mapRef.current.setCenter(currentLocation);
              mapRef.current.setLevel(3);

              // ÌòÑÏû¨ ÏúÑÏπò ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
              setMyLocation(newLocation);

              // ÌòÑÏû¨ ÏúÑÏπò ÎßàÏª§ ÌëúÏãú
              showMyLocationMarker(latitude, longitude);

              console.log("ÌòÑÏû¨ ÏúÑÏπòÎ°ú ÏßÄÎèÑ Ïù¥Îèô ÏôÑÎ£å:", {
                latitude,
                longitude,
              });

              // Ï£ºÎ≥Ä ÏãùÎãπ ÏûêÎèô Í≤ÄÏÉâ
              if (window.kakao.maps.services) {
                const ps = new window.kakao.maps.services.Places();
                clearMarkers();

                ps.keywordSearch(
                  "ÏùåÏãùÏ†ê",
                  (data, status) => {
                    if (
                      status === window.kakao.maps.services.Status.OK &&
                      data.length > 0
                    ) {
                      const results = data
                        .map((p) => ({
                          ...p,
                          distance: getDistance(
                            newLocation.lat,
                            newLocation.lon,
                            parseFloat(p.y),
                            parseFloat(p.x)
                          ),
                        }))
                        .filter((p) => p.distance <= 2000) // 2km Ïù¥ÎÇ¥
                        .sort((a, b) => a.distance - b.distance);

                      setPlaces(results);
                      setHighlightIndex(null);

                      // ÏßÄÎèÑÏóê ÎßàÏª§ ÌëúÏãú
                      const bounds = new window.kakao.maps.LatLngBounds();
                      results.forEach((place, idx) => {
                        const position = new window.kakao.maps.LatLng(
                          place.y,
                          place.x
                        );
                        const marker = new window.kakao.maps.Marker({
                          position,
                          map: mapRef.current,
                        });
                        const infoWindow = new window.kakao.maps.InfoWindow({
                          content: `<div style="padding:6px;">üç¥ ${place.place_name}</div>`,
                        });
                        window.kakao.maps.event.addListener(
                          marker,
                          "click",
                          () => {
                            infoWindowsRef.current.forEach((i) => i.close());
                            infoWindow.open(mapRef.current, marker);
                            mapRef.current.setCenter(position);
                            setHighlightIndex(idx);
                          }
                        );
                        markersRef.current.push(marker);
                        infoWindowsRef.current.push(infoWindow);
                        bounds.extend(position);
                      });

                      // ÌòÑÏû¨ ÏúÑÏπòÎèÑ boundsÏóê Ìè¨Ìï®
                      bounds.extend(currentLocation);
                      mapRef.current.setBounds(bounds);

                      // ÌòÑÏû¨ ÏúÑÏπò ÎßàÏª§ Îã§Ïãú ÌëúÏãú (bounds ÏÑ§Ï†ï ÌõÑ)
                      showMyLocationMarker(newLocation.lat, newLocation.lon);

                      console.log("Ï£ºÎ≥Ä ÏãùÎãπ Í≤ÄÏÉâ ÏôÑÎ£å:", results.length, "Í∞ú");
                    } else {
                      console.log("Ï£ºÎ≥ÄÏóê ÏãùÎãπÏù¥ ÏóÜÏäµÎãàÎã§.");
                    }
                  },
                  {
                    location: currentLocation,
                    radius: 2000,
                  }
                );
              }
            },
            (error) => {
              console.log("ÌòÑÏû¨ ÏúÑÏπòÎ•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§:", error);
              // ÏúÑÏπòÎ•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏúºÎ©¥ Í∏∞Î≥∏ ÏúÑÏπò Ïú†ÏßÄ
            },
            {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 300000, // 5Î∂Ñ
            }
          );
        }
      });
    };
    document.head.appendChild(script);

    getList({ page: 1, size: 20 })
      .then((data) => {
        const productList = data.dtoList || data.list || data.content || [];
        setProducts(productList);
        setFilteredProducts(productList);
      })
      .catch(() =>
        showModal(
          "ÏÉÅÌíà Ï°∞Ìöå Ïò§Î•ò",
          "ÏÉÅÌíà Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.",
          () => setModalVisible(false)
        )
      );
  }, []);

  const getDistance = (lat1, lng1, lat2, lng2) => {
    const toRad = (x) => (x * Math.PI) / 180;
    const R = 6371e3;
    const dLat = toRad(lat2 - lat1);
    const dLng = toRad(lng2 - lng1);
    const a =
      Math.sin(dLat / 2) ** 2 +
      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLng / 2) ** 2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  };

  const clearMarkers = () => {
    markersRef.current.forEach((m) => m.setMap(null));
    infoWindowsRef.current.forEach((i) => i.close());
    markersRef.current = [];
    infoWindowsRef.current = [];
  };

  const showMyLocationMarker = (lat, lon) => {
    if (!mapRef.current) return;
    const pos = new window.kakao.maps.LatLng(lat, lon);
    if (myMarkerRef.current) myMarkerRef.current.setMap(null);
    myMarkerRef.current = new window.kakao.maps.Marker({
      position: pos,
      map: mapRef.current,
      image: new window.kakao.maps.MarkerImage(
        "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png",
        new window.kakao.maps.Size(24, 35),
        { offset: new window.kakao.maps.Point(12, 35) }
      ),
    });
  };

  // ÎÇ¥ ÏúÑÏπò Ï£ºÎ≥Ä ÏùåÏãùÏ†ê Í≤ÄÏÉâ
  const searchNearbyRestaurants = useCallback(() => {
    if (!navigator.geolocation) {
      showModal(
        "ÏúÑÏπò ÏÑúÎπÑÏä§ Ïò§Î•ò",
        "Î∏åÎùºÏö∞Ï†ÄÍ∞Ä ÏúÑÏπò ÏÑúÎπÑÏä§Î•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.",
        () => setModalVisible(false)
      );
      return;
    }

    setIsLoadingLocation(true);

    navigator.geolocation.getCurrentPosition(
      (position) => {
        const { latitude, longitude } = position.coords;
        const newLocation = { lat: latitude, lon: longitude };

        setMyLocation(newLocation);
        showMyLocationMarker(latitude, longitude);

        // ÏßÄÎèÑ Ï§ëÏã¨ÏùÑ ÌòÑÏû¨ ÏúÑÏπòÎ°ú Ïù¥Îèô
        if (mapRef.current) {
          mapRef.current.setCenter(
            new window.kakao.maps.LatLng(latitude, longitude)
          );
          mapRef.current.setLevel(3);
        }

        // Ï£ºÎ≥Ä ÏùåÏãùÏ†ê Í≤ÄÏÉâ
        if (!window.kakao.maps.services) {
          showModal(
            "ÏßÄÎèÑ ÏÑúÎπÑÏä§ Ïò§Î•ò",
            "Ïπ¥Ïπ¥Ïò§Îßµ ÏÑúÎπÑÏä§Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.",
            () => setModalVisible(false)
          );
          setIsLoadingLocation(false);
          return;
        }

        const ps = new window.kakao.maps.services.Places();
        clearMarkers();

        ps.keywordSearch(
          "ÏùåÏãùÏ†ê",
          (data, status) => {
            setIsLoadingLocation(false);

            if (
              status !== window.kakao.maps.services.Status.OK ||
              data.length === 0
            ) {
              setPlaces([]);
              return showModal(
                "Í≤ÄÏÉâ Í≤∞Í≥º ÏóÜÏùå",
                "Ï£ºÎ≥ÄÏóê ÏùåÏãùÏ†êÏù¥ ÏóÜÏäµÎãàÎã§.",
                () => setModalVisible(false)
              );
            }

            const results = data
              .map((p) => ({
                ...p,
                distance: getDistance(
                  newLocation.lat,
                  newLocation.lon,
                  parseFloat(p.y),
                  parseFloat(p.x)
                ),
              }))
              .filter((p) => p.distance <= 2000) // 2km Ïù¥ÎÇ¥
              .sort((a, b) => a.distance - b.distance);

            setPlaces(results);
            setHighlightIndex(null);

            const bounds = new window.kakao.maps.LatLngBounds();
            results.forEach((place, idx) => {
              const position = new window.kakao.maps.LatLng(place.y, place.x);
              const marker = new window.kakao.maps.Marker({
                position,
                map: mapRef.current,
              });
              const infoWindow = new window.kakao.maps.InfoWindow({
                content: `<div style="padding:6px;">üç¥ ${place.place_name}</div>`,
              });
              window.kakao.maps.event.addListener(marker, "click", () => {
                infoWindowsRef.current.forEach((i) => i.close());
                infoWindow.open(mapRef.current, marker);
                mapRef.current.setCenter(position);
                setHighlightIndex(idx);
              });
              markersRef.current.push(marker);
              infoWindowsRef.current.push(infoWindow);
              bounds.extend(position);
            });
            mapRef.current.setBounds(bounds);
            showMyLocationMarker(newLocation.lat, newLocation.lon);
          },
          {
            location: new window.kakao.maps.LatLng(
              newLocation.lat,
              newLocation.lon
            ),
            radius: 2000,
          }
        );
      },
      (error) => {
        setIsLoadingLocation(false);
        let errorMessage = "ÏúÑÏπòÎ•º Í∞ÄÏ†∏Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.";

        switch (error.code) {
          case error.PERMISSION_DENIED:
            errorMessage =
              "ÏúÑÏπò Í∂åÌïúÏù¥ Í±∞Î∂ÄÎêòÏóàÏäµÎãàÎã§. Î∏åÎùºÏö∞Ï†Ä ÏÑ§Ï†ïÏóêÏÑú ÏúÑÏπò Í∂åÌïúÏùÑ ÌóàÏö©Ìï¥Ï£ºÏÑ∏Ïöî.";
            break;
          case error.POSITION_UNAVAILABLE:
            errorMessage = "ÏúÑÏπò Ï†ïÎ≥¥Î•º ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§.";
            break;
          case error.TIMEOUT:
            errorMessage = "ÏúÑÏπò ÏöîÏ≤≠ ÏãúÍ∞ÑÏù¥ Ï¥àÍ≥ºÎêòÏóàÏäµÎãàÎã§.";
            break;
        }

        showModal("ÏúÑÏπò Ïò§Î•ò", errorMessage, () => setModalVisible(false));
      },
      {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 300000, // 5Î∂Ñ
      }
    );
  }, []);

  const handleSearch = useCallback(() => {
    if (!searchKeyword.trim()) {
      return showModal("Í≤ÄÏÉâ ÏöîÏ≤≠ ÌïÑÏöî", "Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.", () =>
        setModalVisible(false)
      );
    }
    if (!window.kakao.maps.services) return;

    if (!myLocation) {
      return navigator.geolocation.getCurrentPosition((pos) => {
        const { latitude, longitude } = pos.coords;
        setMyLocation({ lat: latitude, lon: longitude });
        showMyLocationMarker(latitude, longitude);
        setTimeout(handleSearch, 300);
      });
    }

    const ps = new window.kakao.maps.services.Places();
    clearMarkers();
    ps.keywordSearch(
      searchKeyword,
      (data, status) => {
        if (
          status !== window.kakao.maps.services.Status.OK ||
          data.length === 0
        ) {
          setPlaces([]);
          return showModal(
            "Í≤ÄÏÉâ Í≤∞Í≥º ÏóÜÏùå",
            `"${searchKeyword}"Ïóê ÎåÄÌïú Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.`,
            () => setModalVisible(false)
          );
        }
        const results = data
          .map((p) => ({
            ...p,
            distance: getDistance(
              myLocation.lat,
              myLocation.lon,
              parseFloat(p.y),
              parseFloat(p.x)
            ),
          }))
          .filter((p) => p.distance <= 2000)
          .sort((a, b) => a.distance - b.distance);

        setPlaces(results);
        setHighlightIndex(null);

        const bounds = new window.kakao.maps.LatLngBounds();
        results.forEach((place, idx) => {
          const position = new window.kakao.maps.LatLng(place.y, place.x);
          const marker = new window.kakao.maps.Marker({
            position,
            map: mapRef.current,
          });
          const infoWindow = new window.kakao.maps.InfoWindow({
            content: `<div style="padding:6px;">üç¥ ${place.place_name}</div>`,
          });
          window.kakao.maps.event.addListener(marker, "click", () => {
            infoWindowsRef.current.forEach((i) => i.close());
            infoWindow.open(mapRef.current, marker);
            mapRef.current.setCenter(position);
            setHighlightIndex(idx);
          });
          markersRef.current.push(marker);
          infoWindowsRef.current.push(infoWindow);
          bounds.extend(position);
        });
        mapRef.current.setBounds(bounds);
        showMyLocationMarker(myLocation.lat, myLocation.lon);
      },
      {
        location: new window.kakao.maps.LatLng(myLocation.lat, myLocation.lon),
        radius: 2000,
      }
    );
  }, [searchKeyword, myLocation]);

  // Î∏åÎûúÎìú Í≤ÄÏÉâ Ìï∏Îì§Îü¨
  const handleBrandSearch = useCallback(
    (keyword) => {
      if (!keyword.trim() || !window.kakao.maps.services) return;

      const ps = new window.kakao.maps.services.Places();
      clearMarkers();

      ps.keywordSearch(
        keyword,
        (data, status) => {
          if (
            status === window.kakao.maps.services.Status.OK &&
            data.length > 0
          ) {
            const results = data
              .map((p) => ({
                ...p,
                distance: myLocation
                  ? getDistance(
                      myLocation.lat,
                      myLocation.lon,
                      parseFloat(p.y),
                      parseFloat(p.x)
                    )
                  : 0,
              }))
              .filter((p) => !myLocation || p.distance <= 5000)
              .sort((a, b) => a.distance - b.distance)
              .slice(0, 10);

            const bounds = new window.kakao.maps.LatLngBounds();
            results.forEach((place) => {
              const position = new window.kakao.maps.LatLng(place.y, place.x);
              const marker = new window.kakao.maps.Marker({
                position,
                map: mapRef.current,
              });
              const infoWindow = new window.kakao.maps.InfoWindow({
                content: `<div style="padding:6px;">üè™ ${place.place_name}</div>`,
              });
              window.kakao.maps.event.addListener(marker, "click", () => {
                infoWindowsRef.current.forEach((i) => i.close());
                infoWindow.open(mapRef.current, marker);
                mapRef.current.setCenter(position);
              });
              markersRef.current.push(marker);
              infoWindowsRef.current.push(infoWindow);
              bounds.extend(position);
            });

            if (results.length > 0) {
              mapRef.current.setBounds(bounds);
              if (myLocation) {
                showMyLocationMarker(myLocation.lat, myLocation.lon);
              }
            }
          }
        },
        {
          location: myLocation
            ? new window.kakao.maps.LatLng(myLocation.lat, myLocation.lon)
            : null,
          radius: 5000,
        }
      );
    },
    [myLocation]
  );

  // ÏóîÌÑ∞ÌÇ§ Ìï∏Îì§Îü¨
  const handleEnterKey = useCallback(
    (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        e.stopPropagation();

        if (listType === "place") {
          handleSearch();
        } else {
          // ÏÉÅÌíà ÌÉ≠Ïùº Îïå Ï¶âÏãú Î∏åÎûúÎìú ÌïÑÌÑ∞ÎßÅ Ïã§Ìñâ
          if (!searchKeyword.trim()) {
            setFilteredProducts(products);
            clearMarkers();
          } else {
            // Í∞ïÎ†•Ìïú Î∏åÎûúÎìú ÌïÑÌÑ∞ÎßÅ - Ï¶âÏãú Ïã§Ìñâ
            const filtered = products.filter((product) => {
              // Î∏åÎûúÎìú ÌïÑÎìú Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
              if (
                !product.brand ||
                product.brand === null ||
                product.brand === undefined
              ) {
                return false;
              }

              const productBrand = product.brand
                .toString()
                .toLowerCase()
                .trim();
              const searchValue = searchKeyword.toLowerCase().trim();

              // Ï†ïÌôïÌïú Î∏åÎûúÎìú Îß§Ïπ≠
              const isMatch = productBrand === searchValue;

              // ÎîîÎ≤ÑÍπÖ Î°úÍ∑∏
              console.log(
                `ÏóîÌÑ∞ÌÇ§ - ÏÉÅÌíà: ${product.pname}, Î∏åÎûúÎìú: "${productBrand}", Í≤ÄÏÉâÏñ¥: "${searchValue}", Îß§Ïπ≠: ${isMatch}`
              );

              return isMatch;
            });

            console.log(
              `ÏóîÌÑ∞ÌÇ§ - Í≤ÄÏÉâÏñ¥: "${searchKeyword}", ÌïÑÌÑ∞ÎßÅÎêú ÏÉÅÌíà Ïàò: ${filtered.length}`
            );

            // Ï¶âÏãú ÌïÑÌÑ∞ÎßÅÎêú Í≤∞Í≥º ÏÑ§Ï†ï
            setFilteredProducts(filtered);

            // ÏßÄÎèÑ ÎßàÏª§ÎèÑ Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏
            if (window.kakao.maps.services && myLocation) {
              const ps = new window.kakao.maps.services.Places();
              clearMarkers();

              ps.keywordSearch(
                searchKeyword,
                (data, status) => {
                  if (
                    status === window.kakao.maps.services.Status.OK &&
                    data.length > 0
                  ) {
                    const results = data
                      .map((p) => ({
                        ...p,
                        distance: getDistance(
                          myLocation.lat,
                          myLocation.lon,
                          parseFloat(p.y),
                          parseFloat(p.x)
                        ),
                      }))
                      .filter((p) => p.distance <= 5000)
                      .sort((a, b) => a.distance - b.distance)
                      .slice(0, 10);

                    const bounds = new window.kakao.maps.LatLngBounds();
                    results.forEach((place) => {
                      const position = new window.kakao.maps.LatLng(
                        place.y,
                        place.x
                      );
                      const marker = new window.kakao.maps.Marker({
                        position,
                        map: mapRef.current,
                      });
                      const infoWindow = new window.kakao.maps.InfoWindow({
                        content: `<div style="padding:6px;">üè™ ${place.place_name}</div>`,
                      });
                      window.kakao.maps.event.addListener(
                        marker,
                        "click",
                        () => {
                          infoWindowsRef.current.forEach((i) => i.close());
                          infoWindow.open(mapRef.current, marker);
                          mapRef.current.setCenter(position);
                        }
                      );
                      markersRef.current.push(marker);
                      infoWindowsRef.current.push(infoWindow);
                      bounds.extend(position);
                    });

                    if (results.length > 0) {
                      mapRef.current.setBounds(bounds);
                      showMyLocationMarker(myLocation.lat, myLocation.lon);
                    }
                  }
                },
                {
                  location: new window.kakao.maps.LatLng(
                    myLocation.lat,
                    myLocation.lon
                  ),
                  radius: 5000,
                }
              );
            }
          }
        }
      }
    },
    [listType, searchKeyword, products, myLocation]
  );

  const handleAddCart = (pno) => {
    if (!isLogin) {
      showModal("Î°úÍ∑∏Ïù∏ ÌïÑÏöî", "Ïû•Î∞îÍµ¨ÎãàÎ•º Ïù¥Ïö©ÌïòÎ†§Î©¥ Î°úÍ∑∏Ïù∏ Ìï¥Ï£ºÏÑ∏Ïöî.", () =>
        navigate("/member/login")
      );
      return;
    }

    let qty = 1;
    const exist = cartItems.find((i) => i.pno === pno);
    if (exist) {
      if (
        !window.confirm(
          "Ïù¥ÎØ∏ Ïû•Î∞îÍµ¨ÎãàÏóê ÏûàÎäî ÏÉÅÌíàÏûÖÎãàÎã§. ÏàòÎüâÏùÑ Ï∂îÍ∞ÄÌïòÏãúÍ≤†ÏäµÎãàÍπå?"
        )
      )
        return;
      qty = exist.qty + 1;
    }

    dispatch(postChangeCartAsync({ email: loginState.email, pno, qty }))
      .then((action) => {
        if (action.error) {
          console.error(action.error);
          return showModal("Ï∂îÍ∞Ä Ïã§Ìå®", "Ïû•Î∞îÍµ¨Îãà Ï∂îÍ∞ÄÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.", () =>
            setModalVisible(false)
          );
        }
        dispatch(getCartItemsAsync());
        showModal("Ï∂îÍ∞Ä ÏôÑÎ£å", "ÏÉÅÌíàÏù¥ Ïû•Î∞îÍµ¨ÎãàÏóê ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Îã¥Í≤ºÏäµÎãàÎã§.", () =>
          setModalVisible(false)
        );
      })
      .catch((err) => {
        console.error(err);
        showModal("Ïò§Î•ò Î∞úÏÉù", "Ïû•Î∞îÍµ¨Îãà Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.", () =>
          setModalVisible(false)
        );
      });
  };

  return (
    <>
      <div className="map-container">
        {/* ÏßÄÎèÑ ÏòÅÏó≠ */}
        <div className="map-main-content">
          <div className="map-header">
            <h2>Ïö∞Î¶¨ ÎèôÎÑ§ Í∏∞ÌîÑÌã∞ÏΩò</h2>
            <p>Í∑ºÏ≤ò Í∞ÄÍ≤åÏôÄ ÏÉÅÌíàÏùÑ Ï∞æÏïÑÎ≥¥ÏÑ∏Ïöî</p>
          </div>
          <div className="search-controls">
            <input
              className="search-input"
              value={searchKeyword}
              onChange={(e) => {
                const value = e.target.value;
                setSearchKeyword(value);

                if (listType === "product") {
                  // ÏÉÅÌíà ÌÉ≠Ïùº Îïå Ï¶âÏãú Î∏åÎûúÎìú ÌïÑÌÑ∞ÎßÅ Ïã§Ìñâ
                  if (!value.trim()) {
                    setFilteredProducts(products);
                    clearMarkers();
                  } else {
                    // Í∞ïÎ†•Ìïú Î∏åÎûúÎìú ÌïÑÌÑ∞ÎßÅ - Ï¶âÏãú Ïã§Ìñâ
                    const filtered = products.filter((product) => {
                      // Î∏åÎûúÎìú ÌïÑÎìú Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
                      if (
                        !product.brand ||
                        product.brand === null ||
                        product.brand === undefined
                      ) {
                        return false;
                      }

                      const productBrand = product.brand
                        .toString()
                        .toLowerCase()
                        .trim();
                      const searchValue = value.toLowerCase().trim();

                      // Ï†ïÌôïÌïú Î∏åÎûúÎìú Îß§Ïπ≠
                      const isMatch = productBrand === searchValue;

                      // ÎîîÎ≤ÑÍπÖ Î°úÍ∑∏
                      console.log(
                        `onChange - ÏÉÅÌíà: ${product.pname}, Î∏åÎûúÎìú: "${productBrand}", Í≤ÄÏÉâÏñ¥: "${searchValue}", Îß§Ïπ≠: ${isMatch}`
                      );

                      return isMatch;
                    });

                    console.log(
                      `onChange - Í≤ÄÏÉâÏñ¥: "${value}", ÌïÑÌÑ∞ÎßÅÎêú ÏÉÅÌíà Ïàò: ${filtered.length}`
                    );

                    // Ï¶âÏãú ÌïÑÌÑ∞ÎßÅÎêú Í≤∞Í≥º ÏÑ§Ï†ï
                    setFilteredProducts(filtered);

                    // ÏßÄÎèÑ ÎßàÏª§ÎèÑ Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏
                    if (window.kakao.maps.services) {
                      // ÎÇ¥ ÏúÑÏπòÍ∞Ä ÏóÜÏúºÎ©¥ Î®ºÏ†Ä Í∞ÄÏ†∏Ïò§Í∏∞
                      if (!myLocation) {
                        if (navigator.geolocation) {
                          navigator.geolocation.getCurrentPosition(
                            (position) => {
                              const newLocation = {
                                lat: position.coords.latitude,
                                lon: position.coords.longitude,
                              };
                              setMyLocation(newLocation);

                              // ÏúÑÏπòÎ•º Í∞ÄÏ†∏Ïò® ÌõÑ ÏßÄÎèÑ Í≤ÄÏÉâ Ïã§Ìñâ
                              setTimeout(() => handleBrandSearch(value), 100);
                            },
                            (error) => {
                              console.error(
                                "ÏúÑÏπòÎ•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§:",
                                error
                              );
                              // ÏúÑÏπò ÏóÜÏù¥ÎèÑ Í≤ÄÏÉâ Ïã§Ìñâ
                              handleBrandSearch(value);
                            }
                          );
                        } else {
                          // ÏúÑÏπò ÏßÄÏõê ÏïàÎê®
                          handleBrandSearch(value);
                        }
                      } else {
                        // Ïù¥ÎØ∏ ÏúÑÏπòÍ∞Ä ÏûàÏúºÎ©¥ Î∞îÎ°ú Í≤ÄÏÉâ
                        handleBrandSearch(value);
                      }
                    }
                  }
                }
              }}
              onKeyUp={handleEnterKey}
              placeholder={
                listType === "place" ? "Í∞ÄÍ≤å Ïù¥Î¶Ñ Í≤ÄÏÉâ" : "Î∏åÎûúÎìúÎ™Ö Í≤ÄÏÉâ"
              }
            />
            <button
              className="btn btn-primary"
              onClick={
                listType === "place"
                  ? handleSearch
                  : () => handleBrandSearch(searchKeyword)
              }
            >
              Í≤ÄÏÉâ
            </button>
            <button
              className="btn btn-secondary"
              onClick={searchNearbyRestaurants}
              disabled={isLoadingLocation}
            >
              {isLoadingLocation ? "ÏúÑÏπò ÌôïÏù∏ Ï§ë..." : "ÎÇ¥ ÏúÑÏπò"}
            </button>
          </div>
          <div className="map-wrapper">
            <div id="map" />
          </div>
        </div>

        {/* Î¶¨Ïä§Ìä∏ ÏòÅÏó≠ */}
        <div className="map-sidebar">
          <div className="sidebar-header">
            <h3>üìã Í≤∞Í≥º Î¶¨Ïä§Ìä∏</h3>
          </div>
          <div className="tab-container">
            <button
              className={`tab-button ${listType === "place" ? "active" : ""}`}
              onClick={() => {
                setListType("place");
                // Í≤ÄÏÉâÏ∞ΩÍ≥º ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî Ï†úÍ±∞
                // setSearchKeyword("");
                // setPlaces([]);
                // setFilteredProducts(products);
                // clearMarkers();
              }}
            >
              Í∞ÄÍ≤å
            </button>
            <button
              className={`tab-button ${listType === "product" ? "active" : ""}`}
              onClick={() => {
                setListType("product");
                setFilteredProducts(products);
              }}
            >
              ÏÉÅÌíà
            </button>
          </div>
          <div className="list-container">
            {listType === "place" ? (
              places.length === 0 ? (
                <div className="empty-message">Í∞ÄÍ≤å Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>
              ) : (
                places.map((place, idx) => (
                  <div
                    key={place.id || `${place.x}-${place.y}`}
                    onClick={() =>
                      window.kakao.maps.event.trigger(
                        markersRef.current[idx],
                        "click"
                      )
                    }
                    className={`place-item ${
                      highlightIndex === idx ? "highlighted" : ""
                    }`}
                  >
                    <div className="place-name">
                      {idx + 1}. {place.place_name}
                    </div>
                    <div className="place-details">
                      {place.road_address_name || place.address_name} ¬∑{" "}
                      <span className="place-distance">
                        {Math.round(place.distance)}m
                      </span>
                    </div>
                  </div>
                ))
              )
            ) : filteredProducts.length === 0 ? (
              <div className="empty-message">ÏÉÅÌíàÏù¥ ÏóÜÏäµÎãàÎã§.</div>
            ) : (
              filteredProducts.map((prod) => (
                <div key={prod.pno} className="product-item">
                  {prod.uploadFileNames[0] && (
                    <img
                      src={`${API_SERVER_HOST}/api/products/view/${prod.uploadFileNames[0]}`}
                      alt={prod.pname}
                      className="product-image"
                    />
                  )}
                  <div className="product-name">{prod.pname}</div>
                  <div className="product-price">
                    {prod.price.toLocaleString()}Ïõê
                  </div>
                  <button
                    className="add-cart-btn"
                    onClick={() => handleAddCart(prod.pno)}
                  >
                    üõí Ïû•Î∞îÍµ¨Îãà
                  </button>
                </div>
              ))
            )}
          </div>
        </div>
      </div>

      {modalVisible && (
        <ResultModal
          title={modalTitle}
          content={modalContent}
          callbackFn={() => {
            setModalVisible(false);
            modalCallback && modalCallback();
          }}
        />
      )}
    </>
  );
};

export default MapComponent;
